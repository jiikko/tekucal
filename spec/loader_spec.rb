require 'spec_helper'
require 'tempfile'

describe Tekucal::Loader do
  describe '#load' do
    it '' do
      ical_body = <<~EOH
BEGIN:VCALENDAR
PRODID:-//Google Inc//Google Calendar 70.9054//EN
VERSION:2.0
CALSCALE:GREGORIAN
METHOD:PUBLISH
X-WR-CALNAME:インポート用カレンダー
X-WR-TIMEZONE:Asia/Tokyo
BEGIN:VEVENT
DTSTART:20180407T010000Z
DTEND:20180407T030000Z
DTSTAMP:20180406T140049Z
UID:5@google.com
CREATED:20180406T140022Z
DESCRIPTION:
LAST-MODIFIED:20180406T140022Z
LOCATION:
SEQUENCE:0
STATUS:CONFIRMED
SUMMARY:テストですのんほいパーク
TRANSP:OPAQUE
END:VEVENT
BEGIN:VEVENT
DTSTART:20180407T010000Z
DTEND:20180407T030000Z
DTSTAMP:20180406T140049Z
UID:5@google.com
CREATED:20180406T140022Z
DESCRIPTION:
LAST-MODIFIED:20180406T140022Z
LOCATION:
SEQUENCE:0
STATUS:CONFIRMED
SUMMARY:テストですのんほいパーク2
TRANSP:OPAQUE
END:VEVENT
END:VCALENDAR
      EOH
      file = Tempfile.new
      file.write(ical_body) && file.seek(0)
      loader  = Tekucal::Loader.load(file)
      expect(loader.header).to eq(<<~EOH)
BEGIN:VCALENDAR
PRODID:-//Google Inc//Google Calendar 70.9054//EN
VERSION:2.0
CALSCALE:GREGORIAN
METHOD:PUBLISH
X-WR-CALNAME:インポート用カレンダー
X-WR-TIMEZONE:Asia/Tokyo
END:VCALENDAR
      EOH
      expect(loader.body).to eq(<<~EOH)
BEGIN:VEVENT
DTSTART:20180407T010000Z
DTEND:20180407T030000Z
DTSTAMP:20180406T140049Z
UID:5@google.com
CREATED:20180406T140022Z
DESCRIPTION:
LAST-MODIFIED:20180406T140022Z
LOCATION:
SEQUENCE:0
STATUS:CONFIRMED
SUMMARY:テストですのんほいパーク
TRANSP:OPAQUE
END:VEVENT
BEGIN:VEVENT
DTSTART:20180407T010000Z
DTEND:20180407T030000Z
DTSTAMP:20180406T140049Z
UID:5@google.com
CREATED:20180406T140022Z
DESCRIPTION:
LAST-MODIFIED:20180406T140022Z
LOCATION:
SEQUENCE:0
STATUS:CONFIRMED
SUMMARY:テストですのんほいパーク2
TRANSP:OPAQUE
END:VEVENT
      EOH
      expect(loader.events.size).to eq(2)
      expect(loader.events.first).to be_a(Tekucal::Ical::Event)
    end
  end
end
